#!/usr/bin/env bash

set -Eeuxo pipefail

    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/postgis:build-cache-15.1-postgis-3.3.2' \
      --cache-to 'type=registry,ref=ghcr.io/gui/postgis:build-cache-15.1-postgis-3.3.2,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/postgis:build-cache-15.1-postgis-3.3.2' \
      --file 15/bullseye/postgis-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-15.1-postgis-3.3.2-pgrouting-3.4.1' \
      --cache-to 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-15.1-postgis-3.3.2-pgrouting-3.4.1,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/pgrouting:build-cache-15.1-postgis-3.3.2-pgrouting-3.4.1' \
      --file 15/bullseye/postgis-3-pgrouting-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/postgis:build-cache-14.6-postgis-3.3.2' \
      --cache-to 'type=registry,ref=ghcr.io/gui/postgis:build-cache-14.6-postgis-3.3.2,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/postgis:build-cache-14.6-postgis-3.3.2' \
      --file 14/bullseye/postgis-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-14.6-postgis-3.3.2-pgrouting-3.4.1' \
      --cache-to 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-14.6-postgis-3.3.2-pgrouting-3.4.1,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/pgrouting:build-cache-14.6-postgis-3.3.2-pgrouting-3.4.1' \
      --file 14/bullseye/postgis-3-pgrouting-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/postgis:build-cache-13.9-postgis-3.3.2' \
      --cache-to 'type=registry,ref=ghcr.io/gui/postgis:build-cache-13.9-postgis-3.3.2,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/postgis:build-cache-13.9-postgis-3.3.2' \
      --file 13/bullseye/postgis-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-13.9-postgis-3.3.2-pgrouting-3.4.1' \
      --cache-to 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-13.9-postgis-3.3.2-pgrouting-3.4.1,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/pgrouting:build-cache-13.9-postgis-3.3.2-pgrouting-3.4.1' \
      --file 13/bullseye/postgis-3-pgrouting-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/postgis:build-cache-12.13-postgis-3.3.2' \
      --cache-to 'type=registry,ref=ghcr.io/gui/postgis:build-cache-12.13-postgis-3.3.2,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/postgis:build-cache-12.13-postgis-3.3.2' \
      --file 12/bullseye/postgis-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-12.13-postgis-3.3.2-pgrouting-3.4.1' \
      --cache-to 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-12.13-postgis-3.3.2-pgrouting-3.4.1,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/pgrouting:build-cache-12.13-postgis-3.3.2-pgrouting-3.4.1' \
      --file 12/bullseye/postgis-3-pgrouting-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/postgis:build-cache-11.18-bullseye-postgis-3.3.2' \
      --cache-to 'type=registry,ref=ghcr.io/gui/postgis:build-cache-11.18-bullseye-postgis-3.3.2,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/postgis:build-cache-11.18-bullseye-postgis-3.3.2' \
      --file 11/bullseye/postgis-3/Dockerfile \
      .
    docker buildx build \
      --platform 'linux/amd64,linux/arm64' \
      --pull \
      --push \
      --cache-from 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-11.18-bullseye-postgis-3.3.2-pgrouting-3.4.1' \
      --cache-to 'type=registry,ref=ghcr.io/gui/pgrouting:build-cache-11.18-bullseye-postgis-3.3.2-pgrouting-3.4.1,mode=max' \
      --tag 'localhost:5000/ghcr.io/gui/pgrouting:build-cache-11.18-bullseye-postgis-3.3.2-pgrouting-3.4.1' \
      --file 11/bullseye/postgis-3-pgrouting-3/Dockerfile \
      .
