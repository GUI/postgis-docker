#!/usr/bin/env bash

set -Eeuxo pipefail

<%- versions.each do |postgresql_version, postgis_versions| -%>
  <%- postgis_versions.each do |postgis_version, data| -%>
    docker buildx build \
      --platform "linux/amd64,linux/arm64" \
      --pull \
      --push \
      --cache-from '<%= "type=registry,ref=#{docker_image}:build-cache-#{data.fetch(:postgis_tag)}" %>' \
      --cache-to '<%= "type=registry,ref=#{docker_image}:build-cache-#{data.fetch(:postgis_tag)},mode=max" %>' \
      --tag '<%= "localhost:5000/#{docker_image}:build-cache-#{data.fetch(:postgis_tag)}" %>' \
      --file <%= data.fetch(:filename) %> \
      .
  <%- end -%>
<%- end -%>
