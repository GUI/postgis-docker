#!/usr/bin/env bash

set -Eeuxo pipefail

<%- versions.each do |postgresql_version, postgis_versions| -%>
  <%- postgis_versions.each do |postgis_version, data| -%>
    docker buildx build \
      --platform '<%= data.fetch(:platforms).join(",") %>' \
      --push \
      --cache-from '<%= "type=registry,ref=#{docker_image}:build-cache-#{data.fetch(:postgis_tag)}" %>' \
      <%= data.fetch(:postgis_tags).map { |tag| "--tag '#{docker_image}:#{tag}'" }.join(" ") %> \
      --file <%= data.fetch(:filename) %> \
      .
  <%- end -%>
<%- end -%>
